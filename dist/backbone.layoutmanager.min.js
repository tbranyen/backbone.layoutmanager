/*!
 * backbone.layoutmanager.js v0.5.0
 * Copyright 2012, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */
(function(a){"use strict";var b=a.Backbone,c=a._,d=a.$,e=b.View.extend({constructor:function f(a){a=a||{},this._render=function(a){return a(this).render()},f.setupView(this,a),a.paths&&(this._prefix=a.paths.layout||""),b.View.call(this,a)},insertView:function(a,b){return b?this.setView(a,b,!0):this.setView(a,!0)},insertViews:function(a){return c.each(a,function(b,c){a[c]=[].concat(b)}),this.setViews(a)},getView:function(a){return this.getViews(a).first().value()},getViews:function(a){var b=c.chain(this.views).map(function(a){return[].concat(a)},this).flatten().value();return c.chain(c.filter(b,a?a:c.identity))},setView:function(a,d,f){var g,h,i=this;return c.isString(a)||(f=d,d=a,a=""),!f&&i[a]&&i[a].removeView(),h=d._options(),h.render!==e.prototype.options.render&&(d.render=h.render,h.render=e.prototype.options.render),e.setupView(d,h),d._render=d.render,d.render===b.View.prototype.render&&(d._render=function(a){return a(this).render()}),d.render=function(b){function j(){d.__manager__.hasRendered||(h.partial(i.el,a,d.el,f)&&(d.__manager__.hasRendered=!0),d.delegateEvents()),d.__manager__.handler.resolveWith(d,[d.el]),g.resolveWith(d,[d.el]),c.isFunction(b)&&b.call(d,d.el)}var g=h.deferred();return e.prototype.render.call(d).then(j),g.promise()},f||(d.__manager__.isManaged=!0),!d._prefix&&h.paths&&(d._prefix=h.paths.template||""),this.views=this.views||{},f?(g=this.views[a]=this.views[a]||[],c.isArray(this.views[a])||(g=this.views[a]=[this.views[a]]),g.push(d),d):this.views[a]=d},setViews:function(a){return c.each(a,function(a,b){if(c.isArray(a))return c.each(a,function(a){this.setView(b,a,!0)},this);this.setView(b,a)},this),this},render:function(a){var b=this,d=this._options(),f=d.deferred();return this.removeView(!0),c.each(this.views,function(a,b){if(!c.isArray(a))return;c.each(a,function(a){a.removeView()}),delete this.views[b]},this),b.__manager__.renderDeferred?b.__manager__.renderDeferred:(this._render(e._viewRender).fetch.then(function(){b.__manager__.renderDeferred=f;var a=c.map(b.views,function(a){function e(a,b){if(!a.length)return b();var c=a.shift();c.__manager__.isManaged=!0,c.render(function(){e(a,b)})}var b;return c.isArray(a)?(b=d.deferred(),e(c.clone(a),function(){b.resolve()}),b.promise()):(a.__manager__.isManaged=!0,a.render())});d.when(a).then(function(){f.resolveWith(b,[b.el])})}),f.then(function(){c.isFunction(a)&&a.call(b,b.el),delete b.__manager__.renderDeferred}).promise())},remove:function(){return e.cleanViews(this),this._remove.apply(this,arguments)},_options:function(){return c.extend({},e.prototype.options,this.options)}},{_cache:{},_makeAsync:function(a,b){var c=a.deferred();return c.async=function(){return c._isAsync=!0,b},c},_viewRender:function(a){function h(c,d){e.cache(b,d),d&&g.html(a.el,g.render(d,c)),f.fetch.resolveWith(a,[a.el])}var b,d,f,g=a._options();return{render:function(i){var j=a.template||g.template;return a.serialize&&(g.serialize=a.serialize),!i&&c.isFunction(g.serialize)?i=g.serialize.call(a):!i&&c.isObject(g.serialize)&&(i=g.serialize),f=e._makeAsync(g,c.bind(h,a,i)),f.fetch=g.deferred(),a.__manager__.handler=f,c.isString(j)&&(b=a._prefix+j),(d=e.cache(b))?(h(i,d,b),f):(c.isString(j)?d=g.fetch.call(f,a._prefix+j):j!=null&&(d=g.fetch.call(f,j)),f._isAsync||h(i,d),f)}}},cleanViews:function(a){c.each([].concat(a),function(a){a.unbind(),a.views&&c.each(a.views,function(a){e.cleanViews(a)}),c.isFunction(a.cleanup)&&a.cleanup.call(a)})},cache:function(a,b){if(a in this._cache)return this._cache[a];if(a!=null&&b!=null)return this._cache[a]=b},configure:function(a){c.extend(e.prototype.options,a)},setupView:function(a,d){var e=b.LayoutManager.prototype;d=a.options=c.defaults(d||{},e.options),c.defaults(a,{views:{},__manager__:{}}),this.render!==e.render&&!this._render&&(this._render=this.render,this.render=e.render),a._remove=b.View.prototype.remove,a.remove!==e.remove&&(a._remove=a.remove,a.remove=e.remove),a._prefix="",d.views&&a.setViews(d.views),a.template&&(d.template=a.template)},removeView:function(a,b){c.isObject(a)||(a=a||this,b=a),c.each(a.views,function(a){if(b&&!c.isArray(a))return;c.each([].concat(a),function(a){a.remove(),a.getViews().each(function(a){e.removeView(a,b)})})})}});c.each(["get","set","insert"],function(a){var c=b.View.prototype,d=e.prototype;c[a+"View"]=d[a+"View"],c[a+"Views"]=d[a+"Views"]}),c.extend(b.View.prototype,{removeView:e.removeView,_options:e.prototype._options}),b.Layout=b.LayoutManager=e,e.prototype.options={paths:{},deferred:function(){return d.Deferred()},fetch:function(a){return c.template(d(a).html())},partial:function(a,b,c,e){var f=b?d(a).find(b):d(a);return f.length?(this[e?"append":"html"](f,c),!0):!1},html:function(a,b){d(a).html(b)},append:function(a,b){d(a).append(b)},when:function(a){return d.when.apply(null,a)},render:function(a,b){return a(b)}}})(this);