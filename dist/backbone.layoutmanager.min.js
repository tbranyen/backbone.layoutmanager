/*!
 * backbone.layoutmanager.js v0.2.1
 * Copyright 2012, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed underthe MIT license.
 */
(function(a){function e(a){c.each(c.isArray(a)?a:[a],function(a){a.remove(),a.unbind(),a.views&&c.each(a.views,function(a){e(a)}),c.isFunction(a.cleanup)&&a.cleanup.call(a)})}function f(b){function i(c,e){g.cache(d,e),e&&h.html(b.el,h.render(e,c)),a.setTimeout(function(){f.resolve(b.el)},0)}var d,e,f,h=b._options();return{insert:function(a,c){return c?b.view(a,c,!0):b.view("",a,!0)},render:function(a){var j=b.template||h.template;return b.serialize&&(h.serialize=b.serialize),!a&&c.isFunction(h.serialize)?a=h.serialize.call(b):!a&&c.isObject(h.serialize)&&(a=h.serialize),f=g.makeAsync(h,c.bind(i,b,a)),c.isString(j)&&(d=b._prefix+j),(e=g.cache(d))?(i(a,e,d),f):(c.isString(j)?e=h.fetch.call(f,b._prefix+j):j!=null&&(e=h.fetch.call(f,j)),f._isAsync||i(a,e),f)}}}"use strict";var b=a.Backbone,c=a._,d=a.$,g=b.View.extend({__manager__:{},constructor:function(a){var d=b.LayoutManager.prototype;a=c.extend({},d.options,a),this._render=function(a){return a(this).render()},this.views={},this.render!==d.render&&(this._render=this.render,this.render=d.render),a.paths&&(this._prefix=a.paths.layout||""),a.views&&this.setViews(a.views),this.template&&(a.template=this.template),b.View.call(this,a)},setViews:function(a){c.each(a,function(a,b){this.view(b,a)},this)},view:function(d,f,h){var i,j,k=this;return this.views[d]&&!h&&e(this.views[d]),f.__manager__={},f instanceof g||(f._render=f.render,f.render===b.View.prototype.render&&(f._render=function(a){return a(this).render()}),f.views&&(f.options.views=f.views),c.extend(f,{views:{},view:g.prototype.view,setViews:g.prototype.setViews,_options:g.prototype._options})),h||(f.__manager__.isManaged=!0),f.render=function(b){function i(){f.__manager__.hasRendered||(j.partial(k.el,d,f.el,h),f.delegateEvents(),f.__manager__.hasRendered=!0),e.resolve(f.el).then(function(a){h||(j.detach(f.el),j.partial(k.el,d,f.el)),c.isFunction(b)&&b(f.el)})}var e=j.deferred();if(!f.__manager__.isManaged)return e.resolve(f.el);try{g.prototype.render.call(f,i)}catch(l){a.setTimeout(function(){g.prototype.render.call(f,i)},0)}return e.promise()},j=f._options(),!f._prefix&&j.paths&&(f._prefix=j.paths.template||""),j.views&&f.setViews(j.views),h?(i=this.views[d]=this.views[d]||[],i.push(f),f):this.views[d]=f},render:function(a){var b=this,d=this._options(),e=d.deferred();return this._render(f).then(function(){b.__manager__.hasRendered||d.detach(b.el);var a=c.map(b.views,function(a){function e(a,b){if(!a.length)return b();var c=a.shift();c.__manager__.isManaged=!0,c.render(function(){e(a,b)})}var b;return c.isArray(a)?(b=d.deferred(),e(c.clone(a),function(){b.resolve()}),b.promise()):(a.__manager__.isManaged=!0,a.render())});d.when(a).then(function(){e.resolve(b.el)})}),e.then(function(){b.delegateEvents(),c.isFunction(a)&&a(b.el)}).promise()},_options:function(){return c.extend({},g.prototype.options,this.options)}},{_cache:{},cache:function(a,b){if(a in this._cache)return this._cache[a];if(a!=null&&b!=null)return this._cache[a]=b},configure:function(a){c.isObject(a)&&c.extend(g.prototype.options,a)},makeAsync:function(a,b){var c=a.deferred();return c.async=function(){return c._isAsync=!0,b},c}});b.LayoutManager=g,b.LayoutManager.View=b.View,g.prototype.options={paths:{},deferred:function(){return d.Deferred()},fetch:function(a){return c.template(d(a).html())},partial:function(a,b,c,e){var f=b?d(a).find(b):d(a);this[e?"append":"html"](f,c)},html:function(a,b){d(a).html(b)},append:function(a,b){d(a).append(b)},detach:function(a){d(a).detach()},when:function(a){return d.when.apply(null,a)},render:function(a,b){return a(b)}}})(this)