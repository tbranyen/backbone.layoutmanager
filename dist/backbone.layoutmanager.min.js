/*!
 * backbone.layoutmanager.js v0.6.0
 * Copyright 2012, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */
(function(a){"use strict";var b=a.Backbone,c=a._,d=a.$,e=b.View.prototype._configure,f=b.View.prototype.render,g=b.View.extend({constructor:function(a){a=a||{},g.setupView(this,a),b.View.call(this,a),this._prefix=this._options().paths.layout||""},swapLayout:function(a){return a.views=c.defaults({},this.views,a.views),a.setElement(this.el),a},insertView:function(a,b){return b?this.setView(a,b,!0):this.setView(a,!0)},insertViews:function(a){return c.each(a,function(b,c){a[c]=[].concat(b)}),this.setViews(a)},getView:function(a){return this.getViews(a).first().value()},getViews:function(a){var b=c.chain(this.views).map(function(a){return[].concat(a)},this).flatten().value();return c.chain(c.filter(b,a?a:c.identity))},setView:function(a,b,d){var e,f,h=this;return c.isString(a)||(d=b,b=a,a=""),this.views=this.views||{},!d&&this.views[a]&&(c.isArray(this.views[a])?c.each(this.views[a],function(a){a.remove()}):this.views[a].remove()),f=b._options(),b.__manager__||g.setupView(b,f),b.render=function(e){function j(){f.partial(h.el,a,b.el,d),b.delegateEvents(),b.__manager__.handler&&(b.__manager__.handler.resolveWith(b,[b.el]),delete b.__manager__.handler),i.resolveWith(b,[b.el]),c.isFunction(e)&&e.call(b,b.el)}var i=f.deferred();return b._removeView(),g.prototype.render.call(b).then(j),i.promise()},!b._prefix&&f.paths&&(b._prefix=f.paths.template||""),b.__manager__.parent=this,b.__manager__.selector=a,d?(e=this.views[a]=this.views[a]||[],c.isArray(this.views[a])||(e=this.views[a]=[this.views[a]]),e.push(b),b):this.views[a]=b},setViews:function(a){return c.each(a,function(a,b){if(c.isArray(a))return c.each(a,function(a){this.insertView(b,a)},this);this.setView(b,a)},this),this},render:function(a){var b=this,d=this._options(),e=d.deferred();return this.__manager__.renderDeferred?this.__manager__.renderDeferred:(this._render(g._viewRender).fetch.then(function(){b.__manager__.renderDeferred=e;var a=c.map(b.views,function(a){function e(a,b){if(!a.length)return b();var c=a.shift();c.render(function(){e(a,b)})}var b;return c.isArray(a)?(b=d.deferred(),e(c.clone(a),function(){b.resolve()}),b.promise()):a.render()});d.when(a).then(function(){e.resolveWith(b,[b.el])})}),e.then(function(){c.isFunction(a)&&a.call(b,b.el),delete b.__manager__.renderDeferred}).promise())},remove:function(){return g.cleanViews(this),this._remove.apply(this,arguments)},_options:function(){return c.extend({},g.prototype.options,this.options)}},{_cache:{},_makeAsync:function(a,b){var c=a.deferred();return c.async=function(){return c._isAsync=!0,b},c},_viewRender:function(a){function h(c,d){g.cache(b,d),d&&f.html(a.el,f.render(d,c)),e.fetch.resolveWith(a,[a.el])}var b,d,e,f=a._options();return{render:function(i){var j=a.template||f.template;return a.serialize&&(f.serialize=a.serialize),!i&&c.isFunction(f.serialize)?i=f.serialize.call(a):!i&&c.isObject(f.serialize)&&(i=f.serialize),e=g._makeAsync(f,c.bind(h,a,i)),e.fetch=f.deferred(),a.__manager__.handler=e,c.isString(j)&&(b=a._prefix+j),(d=g.cache(b))?(h(i,d,b),e):(c.isString(j)?d=f.fetch.call(e,a._prefix+j):j!=null&&(d=f.fetch.call(e,j)),e._isAsync||h(i,d),e)}}},cleanViews:function(a){c.each([].concat(a),function(a){a.unbind(),a.views&&c.each(a.views,function(a){g.cleanViews(a)}),c.isFunction(a.cleanup)&&a.cleanup.call(a)})},cache:function(a,b){if(a in this._cache)return this._cache[a];if(a!=null&&b!=null)return this._cache[a]=b},configure:function(a){c.extend(g.prototype.options,a),a.manage&&(b.View.prototype.manage=!0)},setupView:function(a,d){var e,f=b.LayoutManager.prototype,h=c.keys(g.prototype.options).slice(3);c.defaults(a,{views:{},__manager__:{},_options:g.prototype._options,_removeView:g._removeView}),c.extend(a,a.options),d=a.options=c.defaults(d||{},a.options,f.options),c.extend(d,c.pick(this,h)),a._remove=b.View.prototype.remove,a._render=function(a){var b;return c.isFunction(this.beforeRender)&&this.beforeRender.call(this,this),this.trigger("beforeRender",this),a(this).render().then(function(){var a=this.__manager__.parent,b=this,d=function(){c.isFunction(this.afterRender)&&this.afterRender.call(this,this),this.trigger("afterRender",this)};if(!a.__manager__.parent||!a.__manager__.handler)return d.call(this);a.__manager__.handler.then(function(){d.call(b)})})},a.render=g.prototype.render,a.remove!==f.remove&&(a._remove=a.remove,a.remove=f.remove),a._prefix="",e=d.views||a.views,e&&a.setViews(e),a.template&&(d.template=a.template)},_removeView:function(a){a=a||this,a.getViews().each(function(a){var b=a.__manager__;if(c.isBoolean(a.keep)?!a.keep:!a.options.keep){a.remove();if(c.isArray(b.parent.views[b.selector]))return b.parent.getView(function(a,c){a.__manager__.selector===b.selector&&b.parent.views[b.selector].splice(c,1)});delete b.parent[b.selector]}})}});c.each(["get","set","insert"],function(a){var c=b.View.prototype,d=g.prototype;c[a+"View"]=d[a+"View"],c[a+"Views"]=d[a+"Views"]}),b.Layout=b.LayoutManager=g,b.LayoutView=b.View.extend({manage:!0}),b.View.prototype._configure=function(){var a=e.apply(this,arguments);return this.manage&&g.setupView(this),a},g.prototype.options={paths:{},deferred:function(){return d.Deferred()},fetch:function(a){return c.template(d(a).html())},partial:function(a,b,c,e){var f=b?d(a).find(b):d(a);return f.length?(this[e?"append":"html"](f,c),!0):!1},html:function(a,b){d(a).html(b)},append:function(a,b){d(a).append(b)},when:function(a){return d.when.apply(null,a)},render:function(a,b){return a(b)}}})(this)