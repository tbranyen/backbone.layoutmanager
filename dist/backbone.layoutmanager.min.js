/*!
 * backbone.layoutmanager.js v0.7.0
 * Copyright 2012, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */
(function(e){"use strict";var t,n=e.Backbone,r=e._,i=e.$,s=n.View.prototype._configure,o=n.View.prototype.render,u=Array.prototype.push,a=Array.prototype.concat,f=Array.prototype.splice,l=n.View.extend({constructor:function(t){t=t||{},l.setupView(this,t),n.View.call(this,t)},insertView:function(e,t){return t?this.setView(e,t,!0):this.setView(e,!0)},insertViews:function(e){return r.each(e,function(t,n){e[n]=r.isArray(t)?t:[t]}),this.setViews(e)},getView:function(e){return this.getViews(e).first().value()},getViews:function(e){var t=r.chain(this.views).map(function(e){return r.isArray(e)?e:[e]},this).flatten().value();return r.chain(e?r.filter(t,e):t)},setView:function(e,t,n){var i,s,o,u=this;typeof e!="string"&&(n=t,t=e,e=""),this.views=this.views||{},i=t.__manager__,s=this.views[e];if(!i)throw new Error("Please set `View#manage` property with selector '"+e+"' to `true`.");return o=t._options(),i.parent=u,i.selector=e,n?(this.views[e]=a.call([],s||[],t),i.append=!0,t):(i.hasRendered&&o.partial(u.el,i.selector,t.el,i.append),s&&r.each(a.call([],s),function(e){e.remove()}),this.views[e]=t)},setViews:function(e){return r.each(e,function(e,t){if(r.isArray(e))return r.each(e,function(e){this.insertView(t,e)},this);this.setView(t,e)},this),this},render:function(){function a(){function u(){var n=t.afterRender;n&&n.call(e,e),e.trigger("afterRender",e)}var r;i&&(t.contains(i.el,e.el)||t.partial(i.el,n.selector,e.el,n.append)),e.delegateEvents(),o.resolveWith(e,[e]),n.hasRendered=!0,(r=n.queue.shift())?r():delete n.queue;if(s&&!s.hasRendered)return i.on("afterRender",function(){i.off("afterRender",null,this),u()},e);u()}function f(){var t=e._options(),n=e.__manager__,i=n.parent,s=i&&i.__manager__;e._render(l._viewRender,t).done(function(){if(!r.keys(e.views).length)return a();var n=r.map(e.views,function(e){var n=r.isArray(e);return n&&e.length?e[0].render().pipe(function(){return t.when(r.map(e.slice(1),function(e){return e.render()}))}):n?e:e.render()});t.when(n).done(function(){a()})})}var e=this,t=e._options(),n=e.__manager__,i=n.parent,s=i&&i.__manager__,o=t.deferred();return n.queue?u.call(n.queue,function(){f()}):(n.queue=[],f(e,o)),o.view=e,o},remove:function(){return l._removeView(this,!0),this._remove.apply(this,arguments)},_options:function(){return r.extend({},this,l.prototype.options,this.options)}},{_cache:{},_makeAsync:function(e,t){var n=e.deferred();return n.async=function(){return n._isAsync=!0,t},n},_viewRender:function(e,t){function u(r,i){l.cache(n,i),i&&t.html(e.el,t.render(i,r)),s.resolveWith(e,[e])}var n,i,s,o=e.__manager__;return{render:function(){var o,a=t.data||t.serialize,f=e.template||t.template;return r.isFunction(a)&&(a=a.call(e)),s=l._makeAsync(t,function(e){u(a,e)}),r.isString(f)&&(n=t.prefix+f),(i=l.cache(n))?(u(a,i,n),s):(r.isString(f)?i=t.fetch.call(s,t.prefix+f):f!=null&&(i=t.fetch.call(s,f)),s._isAsync||u(a,i),s)}}},_removeViews:function(e,t){r.isBoolean(e)&&(t=e,e=this),e=e||this,e.getViews().each(function(e){(e.__manager__.hasRendered||t)&&l._removeView(e,t)})},_removeView:function(e,t){var n,i=e.__manager__,s=r.isBoolean(e.keep)?e.keep:e.options.keep;if(!s&&(i.append===!0||t)){l.cleanViews(e),e._removeViews(!0),e.$el.remove();if(!i.parent)return;n=i.parent.views[i.selector];if(r.isArray(n))return r.each(n,function(e,t){e.__manager__===i&&f.call(n,t,1)});delete i.parent.views[i.selector]}},cleanViews:function(e){r.each(a.call([],e),function(e){e.unbind(),e.model instanceof n.Model&&e.model.off(null,null,e),e.collection instanceof n.Collection&&e.collection.off(null,null,e),e.cleanup&&e.cleanup.call(e)})},cache:function(e,t){if(e in this._cache)return this._cache[e];if(e!=null&&t!=null)return this._cache[e]=t},configure:function(e){r.extend(l.prototype.options,e),e.manage&&(n.View.prototype.manage=!0)},setupView:function(e,i){if(e.__manager__)return;var s,o,u,f=n.LayoutManager.prototype,c=r.pick(e,t);r.defaults(e,{views:{},__manager__:{},_removeViews:l._removeViews,_removeView:l._removeView},l.prototype),i=e.options=r.defaults(i||{},e.options,f.options),u=r.pick(i,a.call(["events"],r.values(i.events))),r.extend(e,u),(c.render===l.prototype.render||c.render===n.View.prototype.render)&&delete c.render,r.extend(i,c),e._remove=n.View.prototype.remove,e._render=function(e,t){var n=this,r=n.__manager__,i=t.beforeRender;return r.hasRendered&&this._removeViews(),i&&i.call(this,this),this.trigger("beforeRender",this),e(this,t).render()},e.render=l.prototype.render,e.remove!==f.remove&&(e._remove=e.remove,e.remove=f.remove),s=i.views||e.views,r.keys(s).length&&(o=s,e.views={},e.setViews(o)),e.template&&(i.template=e.template,delete e.template)}});n.Layout=n.LayoutView=n.LayoutManager=l,l.VERSION="0.7.0",n.View.prototype._configure=function(){var e=s.apply(this,arguments);return this.manage&&l.setupView(this),e},l.prototype.options={prefix:"",deferred:function(){return i.Deferred()},fetch:function(e){return r.template(i(e).html())},partial:function(e,t,n,r){var s=t?i(e).find(t):i(e);this[r?"append":"html"](s,n)},html:function(e,t){i(e).html(t)},append:function(e,t){i(e).append(t)},when:function(e){return i.when.apply(null,e)},render:function(e,t){return e(t)},contains:function(e,t){return i.contains(e,t)}},t=r.keys(l.prototype.options)})(this);